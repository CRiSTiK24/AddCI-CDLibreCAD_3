name: Librecad3 Builders
'on':
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  linux:
    name: Building LibreCAD3 on ubuntu runner
    runs-on: ubuntu-18.04
    steps:
      - name: Getting packages
        run: >-
          sudo apt-get install qttools5-dev qttools5-dev-tools libqt5opengl5-dev
          liblua5.2-dev git g++ libcairo2-dev libpango-1.0-0 libpango1.0-dev
          libboost-dev libboost-log-dev libboost-program-options-dev
          libqt5svg5-dev libgtest-dev libeigen3-dev libcurl4-gnutls-dev
          libgtk-3-dev libglew-dev rapidjson-dev libbz2-dev libglfw3-dev
          libglm-dev cmake
      - name: Getting a newer cmake
        run: >
          sudo apt remove --purge --auto-remove cmake

          sudo apt update && \

          sudo apt install -y software-properties-common lsb-release && \

          sudo apt clean all

          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc
          2>/dev/null | gpg --dearmor - | sudo tee
          /etc/apt/trusted.gpg.d/kitware.gpg >/dev/null

          sudo apt-add-repository "deb https://apt.kitware.com/ubuntu/
          $(lsb_release -cs) main"

          sudo apt update

          sudo apt install kitware-archive-keyring

          sudo rm /etc/apt/trusted.gpg.d/kitware.gpg

          sudo apt update

          sudo apt install cmake
      - name: gtest installation
        run: |
          cd /usr/src/gtest
          sudo cmake CMakeLists.txt
          sudo make
          cd lib
          sudo cp *.a /usr/lib
      - name: libdxfrw installation
        run: |
          cd
          git clone --branch LibreCAD_3 https://github.com/LibreCAD/libdxfrw
          cd libdxfrw
          mkdir release
          cd release
          cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON ..
          make
          sudo make install
      - name: Cloning librecad
        run: |
          cd
          git clone --recursive https://github.com/CRiSTiK24/AddCI-CDLibreCAD_3
          #git clone --recursive https://github.com/LibreCAD/LibreCAD_3.git
          cd AddCI-CDLibreCAD_3
          #cd LibreCAD_3
          git submodule init #TURNING OFF AN OPTION
          git submodule update --recursive --remote
      - name: Librecad AppImage
        run: >
          mkdir build

          cd build

          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=On

          make -j 4


          sudo make install DESTDIR=AppDir


          sudo cp ../AppImage/librecad.* AppDir/

          wget
          https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage

          wget
          https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage


          chmod a+x linuxdeploy-x86_64.AppImage

          chmod a+x linuxdeploy-plugin-qt-x86_64.AppImage


          sudo LD_LIBRARY_PATH=AppDir/usr/lib/x86_64-linux-gnu/:AppDir/usr/lib64
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
          --executable AppDir/usr/bin/librecad --desktop-file
          AppDir/librecad.desktop --icon-file AppDir/librecad.svg --plugin qt
      - name: Librecad snap
        run: |
          snapcraft
          #sudo snap install librecad_0.0.9_amd64.snap --devmode --dangerous
          #snap run librecad
					
      - name: Uploading AppImage
        uses: actions/upload-artifact@v3.1.0
        with:
          path: ~/AddCI-CDLibreCAD_3/build/LibreCAD*AppImage
          name: LibreCAD3.AppImage
							
      - name: Uploading snap
        uses: actions/upload-artifact@v3.1.0
        with:
          path: ~/AddCI-CDLibreCAD_3/LibreCAD*snap
          name: LibreCAD3.snap

			
  windows:
    name: Building LibreCAD3 on windows runner
    runs-on: windows-latest
    steps:
      - name: Disable Chocolatey confirmations
        run: choco feature enable -n=allowGlobalConfirmation &
      - name: Install Visual Studio 2019 with tools
        run: >-
          choco install visualstudio2019community --package-parameters='"--add
          Microsoft.VisualStudio.Component.VC.CMake.Project
          Microsoft.VisualStudio.Component.VC.Tools.x86.x64
          Microsoft.VisualStudio.Component.Windows10SDK.19041"'
      - name: Clone Repo and enter
        run: |
          git clone --recursive https://github.com/LibreCAD/LibreCAD_3.git
          cd LibreCAD_3
      - name: >-
          Installing conan and getting its dependencies. If it fails, modify the
          profile compiler version and try again
        run: |
          pip install conan
          mkdir conan
          cd conan
          conan install ..
          if NOT %errorlevel% == "0" (
          conan profile update settings.compiler.version=16  default
          conan install ..
          )
      - name: preparing Qt5 env
        run: |
          cd ..\..
          mkdir Qt
      - name: Install Qt5
        uses: jurplel/install-qt-action@v2
        with:
          version: 5.12.2
          host: windows
          arch: win64_msvc2017_64
          dir: '${{ github.workspace }}\Qt'
      - name: Set env variables and path appends
        run: >
          setx QTDIR "%cd%\Qt\5.15.2\msvc2019_64"

          setx QT_QPA_PLATFORM_PLUGIN_PATH "%QTDIR%\plugins\platforms\"

          Powershell.exe -Command "[Environment]::SetEnvironmentVariable('Path',
          $env:Path +
          ';%cd%\Qt\5.15.2\msvc2019_64;%cd%\LibreCAD_3\out\build\x64-Debug\lib;%cd%\Qt\5.15.2\msvc2019_64\bin',
          'User')"
      - name: Building the project
        run: |
					cd LibreCAD_3

					cmake -S C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3 -B C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3\out\build\windows-default -DCMAKE_BUILD_TYPE=RelWithDebInfo --install-prefix C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3\installprefix

					cmake -S C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3 -B C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3\out\build\windows-default -DCMAKE_BUILD_TYPE=RelWithDebInfo --install-prefix C:\Users\CRiSTiK\Desktop\git\scriptsLibrecad3\LibreCAD_3\installprefix

					cd out\build\windows-default

					cmake --build . --config RelWithDebInfo

					cd bin

					WinDeployQt librecad.exe

					cd ..

					cpack -C RelWithDebInfo

		 - name: Uploading exe
        uses: actions/upload-artifact@v3.1.0
        with:
          path: LibreCAD3*exe
          name: LibreCAD3.exe
					
